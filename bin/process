#!/usr/bin/env python

import argparse
import os
import shutil
import sqlite3
import yaml
from jinja2 import Environment, FileSystemLoader


# Some minor code duplication. Trying to keep it to a minimum!
class BenchResults(object):
    def __init__(self, db_path):
        self.db_path = db_path
        self.conn = sqlite3.connect(db_path)
        self.conn.row_factory = sqlite3.Row
        self.runs_cached = self._load_runs(self.conn)
        self.results = {}

    def get_result(self, impl=None, game=None):
        runs = self.runs_cached.keys()
        if impl is not None:
            runs = [r for r in runs if r['impl'] == impl]
        if game is not None:
            runs = [r for r in runs if r['game'] == game]
        results = [self._load_result(run['id']) for run in runs]
        return results

    @staticmethod
    def _load_runs(conn):
        cursor = conn.cursor()
        cursor.execute("SELECT id, run_when, impl, game, version FROM run")
        cache = {}
        for row in cursor:
            run = (row['impl'], row['game'])
            if (run not in cache or
                    cache[run]['run_when'] < row['run_when']):
                cache[run] = row
        return cache

    def _load_result(self, run_id):
        if run_id in self.results:
            return self.results[run_id]
        cursor = self.conn.cursor()
        cursor.execute("SELECT run_id, passed, exitstatus, cmd, level, output, cputime, walltime, memusage FROM result WHERE run_id = ? ORDER BY level desc", run_id)
        result_cache = []
        for row in cursor:
            result_cache.append(row)
        self.results[run_id] = result_cache
        return result_cache

class Site(object):
    def __init__(self, config, results):
        self.config = config
        self.results = results
        self.template_env = self.build_environment()

    def build_environment(self):
        env = {
            'games': self.all_games(),
            'impls': self.all_impls(),
        }
        return env

    def all_games(self):
        games = {}
        for game_name in self.config['game']:
            game = self.config['game'][game_name]
            games[game_name] = {
                'name': game_name,
                'description': game['description'],
            }
        return games

    def all_impls(self):
        impls = {}
        for impl_name in self.config['impl']:
            impl = self.config['impl'][impl_name]
            impls[impl_name] = {
                'name': impl['name'],
            }
        return impls

    def render(self, template_dir, output_dir):
        self.copy_static_files(template_dir, output_dir)
        self.render_templates(template_dir, output_dir)


    def copy_static_files(self, template_dir, output_dir):
        static_files = [
            'css/bootstrap.min.css',
        ]

        for static_file in static_files:
            dir_path, _ = os.path.split(static_file)
            dst_dir = os.path.join(output_dir, dir_path)
            if not os.path.exists(dst_dir):
                os.makedirs(dst_dir)
            src_file = os.path.join(template_dir, static_file)
            shutil.copy(src_file, dst_dir)

    def render_templates(self, template_dir, output_dir):
        env = Environment(loader=FileSystemLoader(template_dir))

        # Render the index file first.
        index_file = os.path.join(output_dir, 'index.html')
        template = env.get_template('index.html')
        with open(index_file, 'w') as f:
            f.write(template.render(self.template_env))

def get_options():
    parser = argparse.ArgumentParser(description="The implementation game")
    parser.add_argument("--config-file", metavar='FILE',
                        help="YAML file containing all implementations.",
                        default="implgame.yaml")
    parser.add_argument("--database", "-d", metavar="DB",
                        help="Output database to get results.",
                        default="implgame.db")
    parser.add_argument("--game-dir",
                        help="Directory containing source for the games.")
    parser.add_argument("--template-dir",
                        help="Directory containing templates.",
                        default="www")
    parser.add_argument("--output-dir",
                        help="Directory for finished site.",
                        default="output")
    return parser.parse_args()

def main():
    args = get_options()
    with open(args.config_file, 'r') as cf:
        config_file_yaml = yaml.safe_load(cf)

    benchdb = BenchResults(args.database)
    site = Site(config_file_yaml, benchdb)
    site.render(args.template_dir, args.output_dir)


if __name__ == '__main__':
    main()
